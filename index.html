import React, { useState, useEffect } from 'react';
import { Activity, Users, Clock, AlertTriangle, TrendingUp, TrendingDown, Minus, Bed, UserCheck, Timer, MapPin, Globe } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell, Area, AreaChart } from 'recharts';

// Simulador de datos por área sanitaria
const generateAreaData = (areaId) => {
  const baseMultiplier = areaId === 'global' ? 9 : 1;
  const randomFactor = areaId === 'global' ? 1 : (0.7 + Math.random() * 0.6);
  
  const now = new Date();
  const timeSlots = Array.from({ length: 24 }, (_, i) => {
    const hour = new Date(now.getTime() - (23 - i) * 60 * 60 * 1000);
    return {
      time: hour.toLocaleTimeString('es-ES', { hour: '2-digit' }),
      admisiones: Math.floor((Math.random() * 8 + 3) * baseMultiplier * randomFactor),
      altas: Math.floor((Math.random() * 6 + 2) * baseMultiplier * randomFactor),
      ocupacion: Math.floor((70 + Math.random() * 25) * randomFactor),
      tiempoEspera: Math.floor((15 + Math.random() * 20) * randomFactor)
    };
  });

  const triageDistribution = areaId === 'global' ? [
    { name: 'I - Resucitación', value: Math.floor(18 * randomFactor), color: '#DC2626' },
    { name: 'II - Emergencia', value: Math.floor(72 * randomFactor), color: '#EA580C' },
    { name: 'III - Urgente', value: Math.floor(135 * randomFactor), color: '#D97706' },
    { name: 'IV - Menos Urgente', value: Math.floor(90 * randomFactor), color: '#65A30D' },
    { name: 'V - No Urgente', value: Math.floor(27 * randomFactor), color: '#16A34A' }
  ] : [
    { name: 'I', value: Math.floor((2 + Math.random() * 3) * randomFactor), color: '#DC2626' },
    { name: 'II', value: Math.floor((6 + Math.random() * 6) * randomFactor), color: '#EA580C' },
    { name: 'III', value: Math.floor((12 + Math.random() * 8) * randomFactor), color: '#D97706' },
    { name: 'IV', value: Math.floor((8 + Math.random() * 6) * randomFactor), color: '#65A30D' },
    { name: 'V', value: Math.floor((2 + Math.random() * 4) * randomFactor), color: '#16A34A' }
  ];

  const camasTotales = areaId === 'global' ? 405 : Math.floor((35 + Math.random() * 20) * randomFactor);
  const camasOcupadas = Math.floor(camasTotales * (0.75 + Math.random() * 0.2));

  return {
    urgencias: {
      area: areaId === 'global' ? 'GLOBAL' : `ÁREA ${areaId}`,
      camasTotales,
      camasOcupadas,
      ocupacionPct: Math.round((camasOcupadas / camasTotales) * 100),
      camasLibres: camasTotales - camasOcupadas,
      tiempoTriaje: Math.floor((15 + Math.random() * 15) * randomFactor),
      tiempoSecundaria: Math.floor((90 + Math.random() * 60) * randomFactor),
      preingresos: Math.floor((5 + Math.random() * 10) * randomFactor),
      porcentajeIngresos: parseFloat((12 + Math.random() * 8).toFixed(1)),
      tiempoEstancia: parseFloat((3 + Math.random() * 3).toFixed(1)),
      nivelesTriaje: triageDistribution,
      admisionesHoy: Math.floor((120 + Math.random() * 80) * baseMultiplier * randomFactor),
      altasHoy: Math.floor((105 + Math.random() * 70) * baseMultiplier * randomFactor),
      tendencias: timeSlots
    },
    comparativas: Array.from({ length: 9 }, (_, i) => ({
      area: i + 1,
      ocupacion: Math.floor(70 + Math.random() * 25),
      admisiones24h: Math.floor(80 + Math.random() * 60),
      tiempoMedio: Math.floor(15 + Math.random() * 20)
    }))
  };
};

// Selector de área
const AreaSelector = ({ selectedArea, onAreaChange }) => {
  const areas = [
    { id: 'global', name: 'GLOBAL', icon: Globe },
    ...Array.from({ length: 9 }, (_, i) => ({
      id: (i + 1).toString(),
      name: `ÁREA ${i + 1}`,
      icon: MapPin
    }))
  ];

  return (
    <div className="flex gap-2">
      {areas.map((area) => {
        const Icon = area.icon;
        return (
          <button
            key={area.id}
            onClick={() => onAreaChange(area.id)}
            className={`px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 ${
              selectedArea === area.id
                ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/25'
                : 'bg-gray-700/50 text-gray-300 hover:bg-gray-600/50 border border-gray-600/50'
            }`}
          >
            <Icon className="w-4 h-4" />
            {area.name}
          </button>
        );
      })}
    </div>
  );
};

// Componente de métrica grande
const BigMetric = ({ title, value, unit, icon: Icon, color, change, subtitle }) => {
  const colorClasses = {
    red: "border-red-500/30 bg-red-500/5 text-red-400",
    blue: "border-blue-500/30 bg-blue-500/5 text-blue-400",
    green: "border-green-500/30 bg-green-500/5 text-green-400",
    yellow: "border-yellow-500/30 bg-yellow-500/5 text-yellow-400",
    purple: "border-purple-500/30 bg-purple-500/5 text-purple-400"
  };

  const TrendIcon = change > 0 ? TrendingUp : change < 0 ? TrendingDown : Minus;
  const trendColor = change > 0 ? 'text-green-400' : change < 0 ? 'text-red-400' : 'text-gray-400';

  return (
    <div className={`p-4 rounded-xl border backdrop-blur-sm ${colorClasses[color]}`}>
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Icon className="w-6 h-6" />
          <span className="text-sm font-medium text-gray-300">{title}</span>
        </div>
        <div className={`flex items-center gap-1 text-sm ${trendColor}`}>
          <TrendIcon className="w-4 h-4" />
          <span>{Math.abs(change)}</span>
        </div>
      </div>
      <div className="text-3xl font-bold text-white mb-1">{value}</div>
      <div className="text-sm text-gray-400">{unit}</div>
      {subtitle && <div className="text-xs text-gray-500 mt-1">{subtitle}</div>}
    </div>
  );
};

// Barra de ocupación mejorada
const EnhancedOccupancy = ({ title, occupied, total, color }) => {
  const percentage = Math.round((occupied / total) * 100);
  const colorClasses = {
    red: "bg-red-500",
    blue: "bg-blue-500",
    green: "bg-green-500",
    yellow: "bg-yellow-500"
  };

  const statusColor = percentage > 90 ? 'red' : percentage > 80 ? 'yellow' : 'green';

  return (
    <div className="p-4 bg-gray-800/50 rounded-xl border border-gray-700/50">
      <div className="flex justify-between items-center mb-3">
        <span className="text-lg font-medium text-white">{title}</span>
        <div className="text-right">
          <span className="text-2xl font-bold text-white">{percentage}%</span>
          <div className={`text-xs ${statusColor === 'red' ? 'text-red-400' : statusColor === 'yellow' ? 'text-yellow-400' : 'text-green-400'}`}>
            {statusColor === 'red' ? 'CRÍTICO' : statusColor === 'yellow' ? 'ALTO' : 'NORMAL'}
          </div>
        </div>
      </div>
      <div className="w-full bg-gray-700 rounded-full h-4 mb-3">
        <div 
          className={`h-4 rounded-full ${colorClasses[color]} transition-all duration-1000 relative`}
          style={{ width: `${percentage}%` }}
        >
          <div className="absolute inset-0 bg-white/20 rounded-full animate-pulse"></div>
        </div>
      </div>
      <div className="grid grid-cols-3 gap-4 text-sm">
        <div className="text-center">
          <div className="text-white font-semibold">{occupied}</div>
          <div className="text-gray-400">Ocupadas</div>
        </div>
        <div className="text-center">
          <div className="text-white font-semibold">{total - occupied}</div>
          <div className="text-gray-400">Libres</div>
        </div>
        <div className="text-center">
          <div className="text-white font-semibold">{total}</div>
          <div className="text-gray-400">Total</div>
        </div>
      </div>
    </div>
  );
};

// Gráfico de tendencias mejorado
const EnhancedTrend = ({ data, dataKey, color, title, height = 120 }) => (
  <div className="p-4 bg-gray-800/50 rounded-xl border border-gray-700/50">
    <h4 className="text-lg font-medium text-white mb-3">{title}</h4>
    <ResponsiveContainer width="100%" height={height}>
      <AreaChart data={data}>
        <defs>
          <linearGradient id={`gradient-${dataKey}`} x1="0" y1="0" x2="0" y2="1">
            <stop offset="5%" stopColor={color} stopOpacity={0.3}/>
            <stop offset="95%" stopColor={color} stopOpacity={0}/>
          </linearGradient>
        </defs>
        <XAxis dataKey="time" stroke="#9CA3AF" fontSize={10} />
        <YAxis stroke="#9CA3AF" fontSize={10} />
        <Area 
          type="monotone" 
          dataKey={dataKey} 
          stroke={color} 
          strokeWidth={2}
          fill={`url(#gradient-${dataKey})`}
        />
      </AreaChart>
    </ResponsiveContainer>
  </div>
);

// Gráfico de sectores mejorado
const EnhancedPie = ({ data, title }) => (
  <div className="p-4 bg-gray-800/50 rounded-xl border border-gray-700/50">
    <h4 className="text-lg font-medium text-white mb-3">{title}</h4>
    <div className="flex items-center gap-4">
      <ResponsiveContainer width={140} height={140}>
        <PieChart>
          <Pie
            data={data}
            cx="50%"
            cy="50%"
            innerRadius={35}
            outerRadius={60}
            paddingAngle={2}
            dataKey="value"
          >
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} fill={entry.color} />
            ))}
          </Pie>
        </PieChart>
      </ResponsiveContainer>
      <div className="flex flex-col gap-2">
        {data.map((entry, index) => (
          <div key={index} className="flex items-center gap-3">
            <div 
              className="w-3 h-3 rounded-full"
              style={{ backgroundColor: entry.color }}
            />
            <span className="text-sm text-gray-300 min-w-0">{entry.name}</span>
            <span className="text-sm font-semibold text-white">{entry.value}</span>
          </div>
        ))}
      </div>
    </div>
  </div>
);

// Tabla comparativa mejorada
const EnhancedComparison = ({ data, selectedArea }) => (
  <div className="p-4 bg-gray-800/50 rounded-xl border border-gray-700/50">
    <h4 className="text-lg font-medium text-white mb-3">Comparativa por Áreas</h4>
    <div className="grid grid-cols-3 gap-4 text-xs text-gray-400 mb-2">
      <div>Área</div>
      <div className="text-center">Ocupación</div>
      <div className="text-center">Admisiones 24h</div>
    </div>
    <div className="space-y-2 max-h-40 overflow-y-auto">
      {data.map((row, index) => (
        <div 
          key={index} 
          className={`grid grid-cols-3 gap-4 py-2 px-2 rounded text-sm ${
            selectedArea === row.area.toString() ? 'bg-blue-500/20 border border-blue-500/30' : ''
          }`}
        >
          <span className="text-white font-medium">Área {row.area}</span>
          <div className="text-center">
            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
              row.ocupacion > 85 ? 'bg-red-500/20 text-red-400' :
              row.ocupacion > 75 ? 'bg-yellow-500/20 text-yellow-400' :
              'bg-green-500/20 text-green-400'
            }`}>
              {row.ocupacion}%
            </span>
          </div>
          <div className="text-center text-white">{row.admisiones24h}</div>
        </div>
      ))}
    </div>
  </div>
);

// Dashboard principal centrado en urgencias
const UrgenciasDashboard = () => {
  const [selectedArea, setSelectedArea] = useState('global');
  const [data, setData] = useState(generateAreaData('global'));
  const [lastUpdate, setLastUpdate] = useState(new Date());

  useEffect(() => {
    setData(generateAreaData(selectedArea));
    setLastUpdate(new Date());
  }, [selectedArea]);

  useEffect(() => {
    const interval = setInterval(() => {
      setData(generateAreaData(selectedArea));
      setLastUpdate(new Date());
    }, 30000);

    return () => clearInterval(interval);
  }, [selectedArea]);

  const { urgencias, comparativas } = data;

  return (
    <div className="h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white p-4 overflow-hidden">
      {/* Header con selector de área */}
      <div className="flex justify-between items-center mb-4">
        <div className="flex items-center gap-6">
          <div>
            <h1 className="text-3xl font-bold bg-gradient-to-r from-red-400 to-orange-400 bg-clip-text text-transparent">
              Dashboard Urgencias
            </h1>
            <p className="text-gray-400 text-sm">Monitorización en Tiempo Real - {urgencias.area}</p>
          </div>
          <div className="flex items-center gap-2 text-green-400">
            <Activity className="w-5 h-5 animate-pulse" />
            <span className="text-sm">ACTIVO</span>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <AreaSelector selectedArea={selectedArea} onAreaChange={setSelectedArea} />
          <div className="text-xs text-gray-400">
            {lastUpdate.toLocaleTimeString('es-ES')}
          </div>
        </div>
      </div>

      {/* Layout principal optimizado */}
      <div className="h-[calc(100vh-120px)] grid grid-cols-12 grid-rows-8 gap-4">
        
        {/* Fila superior - Métricas principales */}
        <div className="col-span-8 row-span-2">
          <div className="grid grid-cols-4 gap-4 h-full">
            <BigMetric
              title="Camas Libres"
              value={urgencias.camasLibres}
              unit="camas disponibles"
              icon={Bed}
              color="green"
              change={2}
              subtitle={`de ${urgencias.camasTotales} totales`}
            />
            <BigMetric
              title="Tiempo Triaje"
              value={urgencias.tiempoTriaje}
              unit="minutos"
              icon={Timer}
              color="blue"
              change={-3}
              subtitle="tiempo promedio"
            />
            <BigMetric
              title="Preingresos"
              value={urgencias.preingresos}
              unit="pacientes"
              icon={Users}
              color="yellow"
              change={1}
              subtitle="esperando cama"
            />
            <BigMetric
              title="Admisiones Hoy"
              value={urgencias.admisionesHoy}
              unit="pacientes"
              icon={UserCheck}
              color="purple"
              change={15}
              subtitle={`${urgencias.altasHoy} altas`}
            />
          </div>
        </div>

        {/* Ocupación de camas */}
        <div className="col-span-4 row-span-2">
          <EnhancedOccupancy
            title="Ocupación de Camas"
            occupied={urgencias.camasOcupadas}
            total={urgencias.camasTotales}
            color="red"
          />
        </div>

        {/* Métricas secundarias */}
        <div className="col-span-6 row-span-2">
          <div className="grid grid-cols-3 gap-4 h-full">
            <BigMetric
              title="Tiempo Secundaria"
              value={urgencias.tiempoSecundaria}
              unit="minutos"
              icon={Clock}
              color="blue"
              change={5}
              subtitle="atención médica"
            />
            <BigMetric
              title="% Ingresos"
              value={urgencias.porcentajeIngresos}
              unit="% pacientes"
              icon={TrendingUp}
              color="purple"
              change={-0.5}
              subtitle="ingresados"
            />
            <BigMetric
              title="Estancia Media"
              value={urgencias.tiempoEstancia}
              unit="horas"
              icon={Clock}
              color="green"
              change={0.2}
              subtitle="tiempo total"
            />
          </div>
        </div>

        {/* Niveles de triaje */}
        <div className="col-span-3 row-span-2">
          <EnhancedPie
            data={urgencias.nivelesTriaje}
            title="Niveles de Triaje"
          />
        </div>

        {/* Comparativa áreas */}
        <div className="col-span-3 row-span-2">
          <EnhancedComparison 
            data={comparativas} 
            selectedArea={selectedArea}
          />
        </div>

        {/* Gráficos de tendencias */}
        <div className="col-span-4 row-span-4">
          <EnhancedTrend
            data={urgencias.tendencias}
            dataKey="admisiones"
            color="#EF4444"
            title="Admisiones por Hora (24h)"
            height={200}
          />
        </div>

        <div className="col-span-4 row-span-4">
          <EnhancedTrend
            data={urgencias.tendencias}
            dataKey="altas"
            color="#22C55E"
            title="Altas por Hora (24h)"
            height={200}
          />
        </div>

        <div className="col-span-4 row-span-4">
          <EnhancedTrend
            data={urgencias.tendencias}
            dataKey="tiempoEspera"
            color="#F59E0B"
            title="Tiempo de Espera (24h)"
            height={200}
          />
        </div>

      </div>
    </div>
  );
};

export default UrgenciasDashboard;
