<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Diario de Urgencias</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }

        header {
            background-color: #005a80; /* SMS Blue */
            color: white;
            padding: 1.5em 0;
            text-align: center;
            border-bottom: 5px solid #ffc425; /* SMS Yellow */
        }

        header h1 {
            margin: 0;
            font-size: 2em;
        }

        main {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        section {
            background-color: white;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        h2 {
            color: #005a80;
            border-bottom: 2px solid #ffc425;
            padding-bottom: 10px;
            margin-top: 0;
        }

        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background-color: #f9f9f9;
        }

        #drop-zone.dragover {
            border-color: #005a80;
            background-color: #e9f5fb;
        }

        #file-name {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }

        .kpi-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }

        .kpi-card {
            background-color: #e9f5fb;
            border: 1px solid #cce4f0;
            border-left: 5px solid #007bff;
            padding: 15px;
            border-radius: 5px;
            flex: 1 1 200px; /* Flex properties for responsiveness */
            min-width: 180px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .kpi-card h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #005a80;
        }

        .kpi-card p {
            font-size: 1.8em;
            font-weight: bold;
            color: #00405c;
            margin-bottom: 0;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters label {
            font-weight: bold;
            margin-right: 5px;
        }

        .filters select, .filters input[type="date"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 150px;
        }

        .chart-container {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fdfdfd;
            height: 400px; 
            position: relative; 
        }
        .chart-container canvas {
            max-height: 100%; 
        }

        footer {
            text-align: center;
            padding: 20px;
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5em;
            }
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            .filters select, .filters input[type="date"] {
                width: 100%;
                margin-bottom: 10px;
            }
            .kpi-card {
                flex-basis: 100%; 
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Diario de Urgencias, Hospitalización y Ocupación</h1>
    </header>

    <main>
        <section id="file-upload-section">
            <h2>Cargar Archivo(s) PDF</h2>
            <div id="drop-zone">
                <p>Arrastra y suelta el/los archivo(s) PDF aquí, o haz clic para seleccionar.</p>
                <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;" multiple>
            </div>
            <p id="file-name"></p>
        </section>

        <section id="kpi-section">
            <h2>Indicadores Clave (KPIs) - Ejemplo para 20/05/2025</h2>
            <div class="kpi-container">
                <div class="kpi-card">
                    <h3>Ocupación Media Camas</h3>
                    <p id="kpi-ocupacion-media">- %</p>
                </div>
                <div class="kpi-card">
                    <h3>Presión Media Urgencias</h3>
                    <p id="kpi-presion-media">- %</p>
                </div>
                <div class="kpi-card">
                    <h3>Total Urgencias (HUVA Gen, 20/05)</h3>
                    <p id="kpi-total-urgencias">-</p>
                </div>
                <div class="kpi-card">
                    <h3>Pacientes COVID (Área I, 20/05)</h3>
                    <p id="kpi-pacientes-covid">-</p>
                </div>
            </div>
        </section>

        <section id="filter-section">
            <h2>Filtros</h2>
            <div class="filters">
                <label for="date-filter">Fecha:</label>
                <select id="date-filter">
                    <option value="all">Todas</option>
                </select>

                <label for="area-filter">Área Sanitaria/Hospital:</label>
                <select id="area-filter">
                    <option value="all">Todas</option>
                </select>
                 <label for="indicator-filter">Indicador:</label>
                <select id="indicator-filter">
                    <option value="all">Todos</option>
                    <option value="entradasUrgencias">Entradas Urgencias</option>
                    <option value="ocupacionCamas">Ocupación Camas</option>
                    <option value="pacientesIngresados">Pacientes Ingresados</option>
                    <option value="pacientesCovidGripeVRS">Pacientes COVID/Gripe/VRS</option>
                </select>
            </div>
        </section>

        <section id="charts-section">
            <h2>Gráficos</h2>
            <div class="chart-container">
                <canvas id="chart-entradas-urgencias"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chart-ocupacion-camas"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chart-pacientes-ingresados-covid"></canvas>
            </div>
        </section>
    </main>

    <footer>
        <p>Servicio Murciano de Salud - Aplicación de Visualización de Datos (Ejemplo)</p>
    </footer>

    <script>
        // Initialize pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // --- Contenido de parser.js ---
        // !!! ESTA SECCIÓN ES LA MÁS CRÍTICA Y PROBABLEMENTE NECESITE AJUSTES !!!
        // !!! REVISA LA CONSOLA (F12) PARA VER EL TEXTO EXTRAÍDO DEL PDF Y ADAPTA ESTAS FUNCIONES !!!
        function cleanValue(valueStr) {
            if (typeof valueStr !== 'string') return valueStr;
            const cleanedStr = valueStr.trim();
            const specialCodes = ["BO", "LE", "E", "T", "WO", "-", "","S/D", "NULL"];
            if (specialCodes.includes(cleanedStr.toUpperCase())) return null;
            let numStr = cleanedStr.replace(/\./g, '');
            numStr = numStr.replace(/,/, '.');
            numStr = numStr.replace('%', '');
            if (!isNaN(parseFloat(numStr)) && isFinite(numStr)) return parseFloat(numStr);
            return cleanedStr; // Devuelve como texto si no es un número reconocible
        }

        function getRelevantPageText(allPagesText, startPage, endPage = null) {
            let relevantText = "";
            const startIndex = startPage - 1;
            const endIndex = endPage ? endPage - 1 : startIndex;
            for (let i = startIndex; i <= endIndex && i < allPagesText.length; i++) {
                relevantText += allPagesText[i] + "\n";
            }
            return relevantText;
        }

        // !!! EJEMPLO DE PARSER: AJUSTAR SEGÚN EL TEXTO REAL EXTRAÍDO !!!
        function parseEntradasUrgencias(tableText) {
            console.log("--- Parseando Entradas Urgencias ---");
            // console.log("Texto para Entradas Urgencias:", tableText.substring(0, 500) + "..."); // Muestra una parte del texto
            const lines = tableText.split('\n').filter(line => line.trim() !== "");
            const data = [];
            let dates = [];
            let currentArea = "";
            
            // AJUSTAR ESTA LÓGICA BASADO EN EL TEXTO REAL DE TU PDF
            const dateLineIndex = lines.findIndex(line => line.toLowerCase().includes("puerta urgencias") && (line.includes("04/21") || line.includes("04 / 21")));
            if (dateLineIndex === -1) {
                console.error("Cabecera de fechas NO encontrada para Entradas Urgencias. Revisa el texto del PDF.");
                return [];
            }

            const headerCellsOriginal = lines[dateLineIndex].split(/\s{2,}/); // Dividir por 2 o más espacios
            const headerCells = headerCellsOriginal.map(s => s.replace(/"/g, '').trim());
            dates = headerCells.filter(cell => /\d{2}\s*\/\s*\d{2}/.test(cell)).map(d => d.replace(/\s/g, ''));
            console.log("Fechas detectadas (Urgencias):", dates);

            const areaRegexGlobal = /^(Area-?\s*([IVX]+|[\w\s]+)-?[\w\s]+)/i;

            for (let i = dateLineIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                // console.log("Procesando línea Urgencias:", line); // DEBUG
                if (!line) continue;

                const cells = line.split(/\s{2,}/).map(s => s.replace(/"/g, '').trim());
                // console.log("Celdas extraídas Urgencias:", cells); // DEBUG

                let potentialArea = cells[0];
                let puertaUrgencias = "";
                let dataCellsStartIndex = 1;

                if (areaRegexGlobal.test(potentialArea)) {
                    currentArea = potentialArea.replace(/^Area-?\s*/, "Área ").replace(/\s*Dete$/, " Oeste").replace(/\s*Norne$/, " Noroeste").replace(/\s*Alliplano/, " Altiplano").replace(/\s*Lneca/, " Lorca");
                    puertaUrgencias = cells[1];
                    dataCellsStartIndex = 2;
                } else if (currentArea && cells.length > dates.length && !areaRegexGlobal.test(cells[0])) { 
                    puertaUrgencias = cells[0];
                    dataCellsStartIndex = 1;
                } else if (currentArea && cells.length <= dates.length +1 && !areaRegexGlobal.test(cells[0]) && cells[0] !== "") { // Para el caso HUSL Mat
                     puertaUrgencias = cells[0];
                     dataCellsStartIndex = 1;
                }
                 else {
                    // console.warn("Línea no reconocida o sin área actual (Urgencias):", line); // DEBUG
                    continue; 
                }
                
                if (!puertaUrgencias || puertaUrgencias.toUpperCase().includes("TOTAL") || puertaUrgencias.length < 3) continue; // Evitar cabeceras o totales

                for (let j = 0; j < dates.length; j++) {
                    const valueStr = cells[j + dataCellsStartIndex];
                    const value = cleanValue(valueStr);
                    if (dates[j] && value !== null && value !== "" && !isNaN(value)) { // Asegurarse que es un número
                        data.push({
                            area: currentArea,
                            puertaUrgencias: puertaUrgencias,
                            fecha: dates[j],
                            entradas: value
                        });
                    }
                }
            }
            if (data.length === 0) console.warn("No se extrajeron datos para Entradas Urgencias. Revisa el parser y el texto del PDF.");
            console.log("Parsed Entradas Urgencias:", data.slice(0,5)); // Muestra solo los primeros 5 para no llenar la consola
            return data;
        }

        // !!! EJEMPLO DE PARSER: AJUSTAR SEGÚN EL TEXTO REAL EXTRAÍDO !!!
        function parsePacientesIngresados(tableText) {
            console.log("--- Parseando Pacientes Ingresados ---");
            const lines = tableText.split('\n').filter(line => line.trim() !== "");
            const data = [];
            let dates = [];

            const dateLineIndex = lines.findIndex(line => (line.includes("04/21") || line.includes("04 / 21")) && (line.includes("05/20") || line.includes("05 / 20")));
            if (dateLineIndex === -1) {
                console.error("Cabecera de fechas NO encontrada para Pacientes Ingresados.");
                return [];
            }
            dates = lines[dateLineIndex].split(/\s{2,}/).map(s => s.replace(/"/g, '').trim()).filter(s => /\d{2}\s*\/\s*\d{2}/.test(s) || /\d{2}\/\d{2}/.test(s)).map(s => s.replace(/\s/g, ''));
            console.log("Fechas detectadas (Ingresados):", dates);


            const normalizedAreaNames = { /* COPIADO DE LA VERSIÓN ANTERIOR, AJUSTAR SI ES NECESARIO */
                "Areal- Murcia Deste": "Área I - Murcia Oeste", "Areall Cartagena": "Área II - Cartagena", "Area III Lorca": "Área III - Lorca", "Area IV- Norne": "Área IV - Noroeste", "Area V Altiplano": "Área V - Altiplano", "Area VI-Vega Media del Segura": "Área VI - Vega Media del Segura", "Anea VII Murcia Este": "Área VII - Murcia Este", "Area Viii Mar Menor": "Área VIII - Mar Menor", "Area IX-Vega Alta del Segira": "Área IX - Vega Alta del Segura"
            };
            const areaKeys = Object.keys(normalizedAreaNames);

            for (let i = dateLineIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const cells = line.split(/\s{2,}/).map(s => s.replace(/"/g, '').trim());
                const potentialAreaKey = cells[0];
                const matchedAreaKey = areaKeys.find(key => potentialAreaKey.toLowerCase().startsWith(key.split(" ")[0].toLowerCase().substring(0,6)));
                
                if (matchedAreaKey) {
                    const area = normalizedAreaNames[matchedAreaKey];
                    for (let j = 0; j < dates.length; j++) {
                        const valueStr = cells[j + 1];
                        const value = cleanValue(valueStr);
                        if (dates[j] && value !== null && value !== "" && !isNaN(value)) {
                            data.push({ area: area, fecha: dates[j], pacientesIngresados: value });
                        }
                    }
                }
            }
            if (data.length === 0) console.warn("No se extrajeron datos para Pacientes Ingresados.");
            console.log("Parsed Pacientes Ingresados:", data.slice(0,5));
            return data;
        }
        
        // !!! EJEMPLO DE PARSER: AJUSTAR SEGÚN EL TEXTO REAL EXTRAÍDO !!!
        function parseOcupacionCamas(tableText) {
            console.log("--- Parseando Ocupacion Camas ---");
            const lines = tableText.split('\n').filter(line => line.trim() !== "");
            const data = [];
            const targetDateColumnName = "05/20";
            
            const areaNameMap = { /* COPIADO DE LA VERSIÓN ANTERIOR, AJUSTAR SI ES NECESARIO */
                "Aves Morcia Dette": "Área I - Murcia Oeste", "Cartagena": "Área II - Cartagena", "Area Lorca": "Área III - Lorca", "Noroeste": "Área IV - Noroeste", "Arsa V Altiplano": "Área V - Altiplano", "Area Vi Vega Meutia del Segura": "Área VI - Vega Media del Segura", "Area V Murcia": "Área VII - Murcia Este", "Area V Mar Menor": "Área VIII - Mar Menor", "Area Vega Alta del Segira": "Área IX - Vega Alta del Segura"
            };
            const areaKeys = Object.keys(areaNameMap);
            let currentArea = "";

            for (const line of lines) {
                // ESTA PARTE ES MUY HEURÍSTICA Y PUEDE FALLAR FÁCILMENTE.
                // SE BASA EN ENCONTRAR LÍNEAS QUE CONTENGAN "Cames Ocupades" Y LUEGO BUSCAR UN %
                const cells = line.split(/\s{3,}|,\s*/).map(s => s.replace(/"/g, '').trim());
                const potentialAreaKey = cells[0];
                const matchedAreaKey = areaKeys.find(key => potentialAreaKey.toLowerCase().startsWith(key.split(" ")[0].toLowerCase().substring(0,4)));

                if (matchedAreaKey) currentArea = areaNameMap[matchedAreaKey];

                if (currentArea && cells.some(cell => cell.toLowerCase().includes("cames ocupades"))) {
                    for (let k = cells.length - 1; k > 0; k--) { // Buscar el % de derecha a izquierda
                        const ocupacionStr = cells[k];
                        if (ocupacionStr && ocupacionStr.includes('%')) {
                             const ocupacion = cleanValue(ocupacionStr);
                             if (ocupacion !== null && !isNaN(ocupacion)) {
                                data.push({ area: currentArea, fecha: targetDateColumnName, porcentajeOcupadas: ocupacion });
                                break; 
                             }
                        }
                    }
                    currentArea = ""; 
                }
            }
            if (data.length === 0) console.warn("No se extrajeron datos para Ocupación Camas.");
            console.log("Parsed Ocupacion Camas (Simplificado para 20/05):", data);
            return data;
        }

        // !!! EJEMPLO DE PARSER: AJUSTAR SEGÚN EL TEXTO REAL EXTRAÍDO !!!
        function parsePacientesCovidGripeVRS(tableText) {
            console.log("--- Parseando Pacientes COVID/Gripe/VRS ---");
            const lines = tableText.split('\n').filter(line => line.trim() !== "");
            const data = [];
            let dates = [];

            const dateLineIndex = lines.findIndex(line => line.toLowerCase().includes("desglose") && (line.includes("04/21") || line.includes("04 / 21")));
            if (dateLineIndex === -1) {
                console.error("Cabecera de fechas NO encontrada para Pacientes COVID/Gripe/VRS.");
                return [];
            }
            dates = lines[dateLineIndex].split(/\s{2,}|,(?!\s)/).map(s => s.replace(/"/g, '').trim()).filter(s => /\d{2}\s*\/\s*\d{2}/.test(s) || /\d{2}\/\d{2}/.test(s)).map(s => s.replace(/\s/g, ''));
            console.log("Fechas detectadas (COVID/Gripe/VRS):", dates);

            let currentArea = "";
            const areaNameMap = { /* COPIADO DE LA VERSIÓN ANTERIOR, AJUSTAR SI ES NECESARIO */
                "Areal- Murcia Oeste": "Área I - Murcia Oeste", "Arnall Cartagena": "Área II - Cartagena", "Arealll- Lurza": "Área III - Lorca", "Area- Norgeste": "Área IV - Noroeste", "Areav- Altiplano": "Área V - Altiplano", "Arna VI-Veg Media del Segura": "Área VI - Vega Media del Segura", "Area VII- Murcia Ege": "Área VII - Murcia Este", "Area Mill Mar Menor": "Área VIII - Mar Menor", "Area X-Vega Alta del Segura": "Área IX - Vega Alta del Segura"
            };
            const areaKeys = Object.keys(areaNameMap);

            for (let i = dateLineIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const cells = line.split(/,(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/"/g, '').trim());
                const firstCell = cells[0];
                const matchedAreaKey = areaKeys.find(key => firstCell.toLowerCase().startsWith(key.split(" ")[0].toLowerCase().substring(0,5)));

                if (matchedAreaKey) currentArea = areaNameMap[matchedAreaKey];

                const desglose = cells[1] ? cells[1].toUpperCase() : "";
                if (currentArea && (desglose === "COVID" || desglose === "GRIPE" || desglose === "VRS")) {
                    for (let j = 0; j < dates.length; j++) {
                        const valueStr = cells[j + 2];
                        const value = cleanValue(valueStr);
                        if (dates[j] && value !== null && value !== "" && !isNaN(value)) {
                            data.push({ area: currentArea, tipo: desglose, fecha: dates[j], pacientes: value });
                        }
                    }
                }
            }
            if (data.length === 0) console.warn("No se extrajeron datos para Pacientes COVID/Gripe/VRS.");
            console.log("Parsed Pacientes COVID/Gripe/VRS:", data.slice(0,5));
            return data;
        }

        async function parsePDFData(allPagesText, fileNameForContext = "archivo") {
            console.log(`Iniciando parseo para: ${fileNameForContext}`);
            const structuredData = {
                entradasUrgencias: [], pacientesIngresados: [], ocupacionCamas: [], pacientesCovidGripeVRS: [],
            };

            // Los números de página son ejemplos, ajústalos según tu PDF
            // Página 3 del PDF es índice 2 en allPagesText
            const urgenciasText = getRelevantPageText(allPagesText, 3, 3); 
            if (urgenciasText) structuredData.entradasUrgencias = parseEntradasUrgencias(urgenciasText);
            
            // Página 9 del PDF es índice 8
            const ingresadosText = getRelevantPageText(allPagesText, 9, 9); 
            if (ingresadosText) structuredData.pacientesIngresados = parsePacientesIngresados(ingresadosText);
            
            // Página 15 del PDF es índice 14
            const ocupacionText = getRelevantPageText(allPagesText, 15, 15); 
             if (ocupacionText) structuredData.ocupacionCamas = parseOcupacionCamas(ocupacionText);

            // Página 11 del PDF es índice 10
            const covidGripeVRSText = getRelevantPageText(allPagesText, 11, 11); 
            if (covidGripeVRSText) structuredData.pacientesCovidGripeVRS = parsePacientesCovidGripeVRS(covidGripeVRSText);

            return structuredData;
        }

        // --- Contenido de ui.js ---
        let charts = {};

        function populateFilters(data) {
            const dateFilter = document.getElementById('date-filter');
            const areaFilter = document.getElementById('area-filter');
            const allDates = new Set();
            const allAreas = new Set();

            (data.entradasUrgencias || []).forEach(item => { allDates.add(item.fecha); allAreas.add(item.area); if (item.puertaUrgencias) allAreas.add(item.puertaUrgencias); });
            (data.ocupacionCamas || []).forEach(item => { allDates.add(item.fecha); allAreas.add(item.area); });
            (data.pacientesIngresados || []).forEach(item => { allDates.add(item.fecha); allAreas.add(item.area); });
            (data.pacientesCovidGripeVRS || []).forEach(item => { allDates.add(item.fecha); allAreas.add(item.area); });

            const sortedDates = Array.from(allDates).sort((a, b) => {
                const [dayA, monthA] = a.split('/'); const [dayB, monthB] = b.split('/');
                return new Date(`2025-${monthA}-${dayA}`) - new Date(`2025-${monthB}-${dayB}`); // Asume año 2025 para ordenar
            });

            dateFilter.innerHTML = '<option value="all">Todas las Fechas</option>';
            sortedDates.forEach(date => { const option = document.createElement('option'); option.value = date; option.textContent = date; dateFilter.appendChild(option); });

            areaFilter.innerHTML = '<option value="all">Todas las Áreas/Hospitales</option>';
            Array.from(allAreas).sort().forEach(area => { if (!area) return; const option = document.createElement('option'); option.value = area; option.textContent = area; areaFilter.appendChild(option); });
        }

        function updateKPIs(data) {
            const targetDate = "20/05"; // Para KPIs "del día"

            let kpiOcupacion = "N/A";
            if (data.ocupacionCamas && data.ocupacionCamas.length > 0) {
                const ocupacionHoy = data.ocupacionCamas.filter(d => d.fecha === targetDate && d.porcentajeOcupadas != null);
                if (ocupacionHoy.length > 0) {
                    const totalOcupacion = ocupacionHoy.reduce((sum, item) => sum + item.porcentajeOcupadas, 0);
                    kpiOcupacion = `${(totalOcupacion / ocupacionHoy.length).toFixed(2)} %`;
                }
            }
            document.getElementById('kpi-ocupacion-media').textContent = kpiOcupacion;
            document.getElementById('kpi-presion-media').textContent = 'N/A (Parsear)'; // Necesita datos de Presión Urgencias

            let kpiTotalUrg = "N/A";
            if (data.entradasUrgencias && data.entradasUrgencias.length > 0) {
                const urgenciasTarget = data.entradasUrgencias.find(d => d.puertaUrgencias === "HUVA Gen" && d.fecha === targetDate);
                if(urgenciasTarget) kpiTotalUrg = urgenciasTarget.entradas;
            }
            document.getElementById('kpi-total-urgencias').textContent = kpiTotalUrg;

            let kpiCovid = "N/A";
            if (data.pacientesCovidGripeVRS && data.pacientesCovidGripeVRS.length > 0) {
                const covidTarget = data.pacientesCovidGripeVRS.find(d => d.area === "Área I - Murcia Oeste" && d.tipo === "COVID" && d.fecha === targetDate);
                if(covidTarget) kpiCovid = covidTarget.pacientes;
            }
            document.getElementById('kpi-pacientes-covid').textContent = kpiCovid;
        }

        function renderChart(chartId, chartConfig) {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) { console.error(`Elemento canvas con ID ${chartId} no encontrado.`); return; }
            const ctx = chartElement.getContext('2d');
            if (charts[chartId]) charts[chartId].destroy();
            charts[chartId] = new Chart(ctx, chartConfig);
        }

        function displayEntradasUrgenciasChart(urgenciasDataAll, selectedArea = 'all') {
            const urgenciasData = urgenciasDataAll || [];
            let filteredData = urgenciasData;
            if (selectedArea !== 'all') filteredData = urgenciasData.filter(item => item.area === selectedArea || item.puertaUrgencias === selectedArea);
            
            if (!filteredData || filteredData.length === 0) {
                 renderChart('chart-entradas-urgencias', {type: 'line', data:{labels:[], datasets:[]}, options:{plugins:{title:{display:true, text:'Sin datos para Entradas Urgencias con los filtros actuales'}}}});
                 return;
            }

            const datasets = {}; const labels = new Set();
            filteredData.forEach(item => { const key = item.puertaUrgencias || item.area; if (!datasets[key]) datasets[key] = {}; datasets[key][item.fecha] = (datasets[key][item.fecha] || 0) + item.entradas; labels.add(item.fecha); });
            const sortedLabels = Array.from(labels).sort((a, b) => { const [dayA, monthA] = a.split('/'); const [dayB, monthB] = b.split('/'); return new Date(`2025-${monthA}-${dayA}`) - new Date(`2025-${monthB}-${dayB}`); });
            const chartDatasets = Object.keys(datasets).map((key, index) => { const color = `hsl(${(index * (360 / (Object.keys(datasets).length || 1)))}, 70%, 50%)`; return { label: key, data: sortedLabels.map(date => datasets[key][date] || 0), borderColor: color, backgroundColor: color + '33', fill: false, tension: 0.1 }; });
            renderChart('chart-entradas-urgencias', { type: 'line', data: { labels: sortedLabels, datasets: chartDatasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Entradas Totales en Urgencias por Día y Área/Puerta' }, legend: { position: 'top' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Número de Entradas' } } } } });
        }

        function displayOcupacionCamasChart(ocupacionDataAll, selectedArea = 'all') {
            const ocupacionData = ocupacionDataAll || [];
            let filteredData = ocupacionData;
             if (selectedArea !== 'all') filteredData = ocupacionData.filter(item => item.area === selectedArea);
            if (!filteredData || filteredData.length === 0) {
                 renderChart('chart-ocupacion-camas', {type: 'bar', data:{labels:[], datasets:[]}, options:{plugins:{title:{display:true, text:'Sin datos para Ocupación Camas con los filtros actuales'}}}});
                 return;
            }
            const labels = filteredData.map(item => item.area); const dataValues = filteredData.map(item => item.porcentajeOcupadas);
            renderChart('chart-ocupacion-camas', { type: 'bar', data: { labels: labels, datasets: [{ label: '% Ocupación Camas (el 20/05)', data: dataValues, backgroundColor: 'rgba(255, 159, 64, 0.5)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: '% Ocupación Camas (20/05)' } }, scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'Porcentaje (%)' } } } } });
        }

        function displayPacientesCovidChart(covidDataAll, selectedArea = 'all') {
            const covidData = covidDataAll || [];
            let filteredData = covidData;
            if (selectedArea !== 'all') filteredData = covidData.filter(item => item.area === selectedArea);
             if (!filteredData || filteredData.length === 0) {
                 renderChart('chart-pacientes-ingresados-covid', {type: 'line', data:{labels:[], datasets:[]}, options:{plugins:{title:{display:true, text:'Sin datos para Pacientes COVID/Gripe/VRS con los filtros actuales'}}}});
                 return;
            }
            const datasets = {}; const labels = new Set();
            filteredData.forEach(item => { const key = item.tipo; if (!datasets[key]) datasets[key] = {}; datasets[key][item.fecha] = (datasets[key][item.fecha] || 0) + item.pacientes; labels.add(item.fecha); });
            const sortedLabels = Array.from(labels).sort((a, b) => { const [dayA, monthA] = a.split('/'); const [dayB, monthB] = b.split('/'); return new Date(`2025-${monthA}-${dayA}`) - new Date(`2025-${monthB}-${dayB}`); });
            const typeColors = { "COVID": "rgba(255, 99, 132, 0.7)", "GRIPE": "rgba(54, 162, 235, 0.7)", "VRS": "rgba(75, 192, 192, 0.7)" };
            const chartDatasets = Object.keys(datasets).map(key => ({ label: key, data: sortedLabels.map(date => datasets[key][date] || 0), borderColor: typeColors[key] ? typeColors[key].replace('0.7', '1') : 'rgba(0,0,0,1)', backgroundColor: typeColors[key] || 'rgba(0,0,0,0.5)', tension: 0.1, fill: false }));
            renderChart('chart-pacientes-ingresados-covid', { type: 'line', data: { labels: sortedLabels, datasets: chartDatasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Evolución Pacientes COVID, Gripe, VRS' } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Número de Pacientes' } } } } });
        }

        function updateDashboard(fullData, filters) {
            if (!fullData) {
                console.warn("updateDashboard llamado sin datos (fullData es null/undefined)");
                return;
            }
            let { entradasUrgencias = [], ocupacionCamas = [], pacientesCovidGripeVRS = [], pacientesIngresados = [] } = fullData;

            if (filters.date !== 'all') {
                entradasUrgencias = entradasUrgencias.filter(d => d.fecha === filters.date);
                ocupacionCamas = ocupacionCamas.filter(d => d.fecha === filters.date || filters.date === "20/05");
                pacientesCovidGripeVRS = pacientesCovidGripeVRS.filter(d => d.fecha === filters.date);
                if (pacientesIngresados) pacientesIngresados = pacientesIngresados.filter(d => d.fecha === filters.date);
            }
            
            updateKPIs(fullData); 

            document.getElementById('chart-entradas-urgencias').parentElement.style.display = (filters.indicator === 'all' || filters.indicator === 'entradasUrgencias') ? 'block' : 'none';
            document.getElementById('chart-ocupacion-camas').parentElement.style.display = (filters.indicator === 'all' || filters.indicator === 'ocupacionCamas') ? 'block' : 'none';
            document.getElementById('chart-pacientes-ingresados-covid').parentElement.style.display = (filters.indicator === 'all' || filters.indicator === 'pacientesCovidGripeVRS') ? 'block' : 'none';

            if (filters.indicator === 'all' || filters.indicator === 'entradasUrgencias') displayEntradasUrgenciasChart(entradasUrgencias, filters.area);
            if (filters.indicator === 'all' || filters.indicator === 'ocupacionCamas') {
                const ocupacionDataToDisplay = (ocupacionCamas && ocupacionCamas.length > 0 && filters.date !== 'all') ? ocupacionCamas : fullData.ocupacionCamas.filter(d => d.fecha === "20/05");
                displayOcupacionCamasChart(ocupacionDataToDisplay, filters.area);
            }
            if (filters.indicator === 'all' || filters.indicator === 'pacientesCovidGripeVRS') displayPacientesCovidChart(pacientesCovidGripeVRS, filters.area);
        }

        // --- Contenido de app.js ---
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('pdf-file-input');
            const fileNameDisplay = document.getElementById('file-name');
            let globalPDFData = null;

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (event) => { event.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            
            dropZone.addEventListener('drop', (event) => { event.preventDefault(); dropZone.classList.remove('dragover'); if (event.dataTransfer.files.length > 0) handleFiles(event.dataTransfer.files); });
            fileInput.addEventListener('change', (event) => { if (event.target.files.length > 0) handleFiles(event.target.files); });

            async function handleFiles(files) {
                if (files.length === 0) return;
                fileNameDisplay.textContent = `${files.length} archivo(s) cargado(s): ${Array.from(files).map(f => f.name).join(', ')}`;
                ['kpi-ocupacion-media', 'kpi-total-urgencias', 'kpi-pacientes-covid', 'kpi-presion-media'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = "Procesando...";
                });

                let allDataFromAllFiles = { entradasUrgencias: [], pacientesIngresados: [], ocupacionCamas: [], pacientesCovidGripeVRS: [] };

                for (const file of files) {
                    if (file.type !== "application/pdf") { alert(`El archivo ${file.name} no es un PDF y será omitido.`); continue; }
                    const reader = new FileReader();
                    const fileProcessPromise = new Promise((resolve, reject) => {
                        reader.onload = async function(event) {
                            const pdfData = new Uint8Array(event.target.result);
                            try {
                                const pdf = await pdfjsLib.getDocument({data: pdfData}).promise;
                                const numPages = pdf.numPages;
                                const allPagesTextPromises = [];
                                for (let i = 1; i <= numPages; i++) {
                                    allPagesTextPromises.push(
                                        pdf.getPage(i).then(page =>
                                            page.getTextContent().then(textContent =>
                                                textContent.items.map(item => item.str).join(' ') // Simple join
                                            )
                                        )
                                    );
                                }
                                const allPagesText = await Promise.all(allPagesTextPromises);
                                
                                console.log(`--- TEXTO CRUDO PDF (${file.name}) ---`);
                                console.log("PÁGINA 3 (Índice 2):", allPagesText[2] ? allPagesText[2].substring(0,1500) : "No disponible/Corta");
                                console.log("PÁGINA 9 (Índice 8):", allPagesText[8] ? allPagesText[8].substring(0,1500) : "No disponible/Corta");
                                console.log("PÁGINA 11 (Índice 10):", allPagesText[10] ? allPagesText[10].substring(0,1500) : "No disponible/Corta");
                                console.log("PÁGINA 15 (Índice 14):", allPagesText[14] ? allPagesText[14].substring(0,1500) : "No disponible/Corta");

                                const currentFileParsedData = await parsePDFData(allPagesText, file.name);
                                
                                // Acumular datos
                                allDataFromAllFiles.entradasUrgencias.push(...(currentFileParsedData.entradasUrgencias || []));
                                allDataFromAllFiles.pacientesIngresados.push(...(currentFileParsedData.pacientesIngresados || []));
                                allDataFromAllFiles.ocupacionCamas.push(...(currentFileParsedData.ocupacionCamas || []));
                                allDataFromAllFiles.pacientesCovidGripeVRS.push(...(currentFileParsedData.pacientesCovidGripeVRS || []));
                                resolve();
                            } catch (error) {
                                console.error(`Error procesando PDF ${file.name}:`, error);
                                alert(`Error al procesar PDF ${file.name}. Revisa la consola.`);
                                reject(error);
                            }
                        };
                        reader.onerror = (error) => { console.error(`Error leyendo archivo ${file.name}:`, error); alert(`Error al leer archivo ${file.name}.`); reject(error); }
                        reader.readAsArrayBuffer(file);
                    });
                    try { await fileProcessPromise; } catch (e) { /* Error ya manejado */ }
                }

                globalPDFData = allDataFromAllFiles;
                if (globalPDFData && (globalPDFData.entradasUrgencias.length > 0 || globalPDFData.ocupacionCamas.length > 0)) {
                    console.log("Datos Estructurados Finales (múltiples archivos):", globalPDFData);
                    populateFilters(globalPDFData);
                    applyFiltersAndDisplay();
                } else {
                    fileNameDisplay.textContent += " - No se pudieron extraer datos válidos de los archivos.";
                    updateKPIs({}); // Limpiar KPIs
                    // Limpiar gráficos (opcional, o mostrar mensaje de "sin datos")
                    ['chart-entradas-urgencias', 'chart-ocupacion-camas', 'chart-pacientes-ingresados-covid'].forEach(id => renderChart(id, {type:'line', data:{labels:[], datasets:[]}, options:{plugins:{title:{display:true, text:'Sin datos'}}}}));
                }
            }

            document.getElementById('date-filter').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('area-filter').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('indicator-filter').addEventListener('change', applyFiltersAndDisplay);
            
            function applyFiltersAndDisplay() {
                if (!globalPDFData) { console.warn("applyFiltersAndDisplay llamado sin globalPDFData."); return; }
                const filters = { date: document.getElementById('date-filter').value, area: document.getElementById('area-filter').value, indicator: document.getElementById('indicator-filter').value };
                console.log("Aplicando filtros:", filters);
                updateDashboard(globalPDFData, filters);
            }
            
            // Estado inicial de los gráficos
            ['chart-entradas-urgencias', 'chart-ocupacion-camas', 'chart-pacientes-ingresados-covid'].forEach(id => {
                const el = document.getElementById(id);
                if (el) renderChart(id, {type:'line', data:{labels:[], datasets:[]}, options:{plugins:{title:{display:true, text:'Carga un PDF para ver los datos'}}}});
            });
        });
    </script>
</body>
</html>
